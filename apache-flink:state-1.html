<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="," />





  <link rel="alternate" href="/atom.xml" title="yangyichao-mango's blog" type="application/atom+xml" />






<meta name="description" content="本站&amp;作者">
<meta property="og:type" content="website">
<meta property="og:title" content="深入浅出 | 全局一致性快照">
<meta property="og:url" content="apache-flink:state-1.html">
<meta property="og:site_name" content="yangyichao-mango&#39;s blog">
<meta property="og:description" content="本站&amp;作者">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-09-12T06:21:53.000Z">
<meta property="article:modified_time" content="2021-04-04T08:55:33.143Z">
<meta property="article:author" content="yangyichao-mango">
<meta property="article:tag" content="Apache Flink">
<meta name="twitter:card" content="summary">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://yangyichao-mango.github.io/apache-flink:state-1.html"/>





  <title>深入浅出 | 全局一致性快照 | yangyichao-mango's blog</title>
  








<meta name="generator" content="Hexo 5.4.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">yangyichao-mango's blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/%20" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    
    
    
    <div class="post-block page">
      <header class="post-header">

	<h1 class="post-title" itemprop="name headline">深入浅出 | 全局一致性快照</h1>


	<div class="post-meta">
		<div class="post-description">本站&作者</div>
	</div>


</header>

      
      
      
      <div class="post-body">
        
        
          <h1 id="深入浅出-全局一致性快照"><a href="#深入浅出-全局一致性快照" class="headerlink" title="深入浅出 | 全局一致性快照"></a>深入浅出 | 全局一致性快照</h1><blockquote>
<p>本系列每篇文章都比较短小，不定期更新，从一些实际的 case 出发抛砖引玉，提高小伙伴的姿♂势水平。本文介绍 Flink sink schema 字段设计小技巧，阅读时长大概 2 分钟，话不多说，直接进入正文！</p>
</blockquote>
<h1 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h1><ol>
<li>什么是状态？</li>
</ol>
<p>发散思维的去思考状态。我们所理解的状态不仅仅只限于 flink 的状态。让大家了解到状态是一个无处不在的东西</p>
<ol start="2">
<li>什么是全局一致性快照？和状态有什么关系？</li>
</ol>
<p>全局一致性快照的一些生活、工作中应用的例子</p>
<ol start="3">
<li>为什么需要一致性快照？全局一致性快照和 flink 的关系？</li>
</ol>
<p>jvm GC，分布式应用做故障恢复（比如 flink），死锁检测等</p>
<ol start="4">
<li>全局一致性快照的分布式应用举例</li>
</ol>
<p>通过一个简单分布式应用介绍一下全局一致性状态是每时每刻都存在的。时间轴上的每一个时刻都存在一个全局一致性快照（类似拍照片）。flink 做 cp，sp，类似于每隔固定的时间从时间轴上的一个点拿出来这个时间点对应的一个全局一致性状态</p>
<ol start="5">
<li>全局一致性快照的标准定义</li>
</ol>
<p>假如说有两个事件，a和b，在绝对时间下，如果a发生在b之前，且b被包含在快照当中，那么则a事件或者其对快照产生的影响也被包含在快照当中</p>
<p>6.怎么实现全局一致性快照？</p>
<p>同步去做，包括时钟同步、Stop-the-world，但是这两种方法都不可接受；<br>既然同步无法做，那如果异步能做出相同的全局一致性状态也可以</p>
<ol start="7">
<li><p>分布式应用的全局一致性快照其 Process 状态和 Channel状态到底需要记录什么？其之间需要满足什么关系的一些思考？<br>不是必须要在同一时刻嘛，为啥还能异步去做？只要异步做出来的状态和同步做出来的状态效果一致也可以。</p>
</li>
<li><p>Chandy-Lamport 算法流程、例子</p>
</li>
</ol>
<p>介绍 Chandy-Lamport 算法流程并以一个例子介绍其执行过程</p>
<p>9.flink 实现的全局一致性快照介绍</p>
<h1 id="什么是状态？（了解状态）"><a href="#什么是状态？（了解状态）" class="headerlink" title="什么是状态？（了解状态）"></a>什么是状态？（了解状态）</h1><p>目标：首先想让大家发散思维的去思考状态？我们所理解的状态不仅仅只限于 flink 的状态。让大家了解到状态是一个普遍存在的东西<br>定义：就是当前计算需要依赖到之前计算的结果，那么之前计算的结果就是状态<br>举例：</p>
<ol>
<li>比如生活中的例子：为什么我知道这个是电脑，因为眼睛接收到外界的图案，然后我的大脑接收到这个图案后，拿记忆中存储的图案进行对比，匹配得到这是电脑。那么记忆中存储的图案就是状态；日久生情等都存在状态</li>
<li>比如 web server 应用中的状态：打开青藤 flink 页面，列表展示了羊艺超的归属任务。其中就是 web client 发了查询羊艺超的归属任务请求，web server 接收到请求之后，然后去 mysql 中进行查询匹配返回。那么 mysql 中存储的内容就是状态</li>
</ol>
<ol start="3">
<li>比如 flink 应用中的状态：要去重，就要存储所有的 key；要获取当前最大值，那么历史最大值就是状态</li>
</ol>
<p>2.什么是全局一致性快照？（了解全局一致性快照）<br>全局：代表是一个分布式的<br>一致性快照：代表绝对时间的同一时刻的状态<br>相当于打开上帝视角，去观察同一时刻的应用所有的状态<br>其实这里的快照 = 状态，文章之后我可能会把这两个词混用，大家明白他们的意思一致即可</p>
<p>● 比如生活中的例子：比如拍了一个照片，那么照片的内容就是当时的一个全局一致性快照；每一个首脑都是一个进程，所有的进程的状态在同一时刻的组合就是一个全局一致性快照</p>
<p>● 比如分布式应用的例子：首先是一个分布式应用，它有多个进程分布在多个服务器上；其次，它在应用内部有自己的处理逻辑和状态；第三，应用间是可以互相通信的；第四，在这种分布式的应用，有内部状态，硬件可以通信的情况下；某一时刻的全局状态，就叫做全局的快照。</p>
<p>分布式应用某一时刻的全局一致性快照 = 各个 process 的本地状态 + channel 中正在传递的消息</p>
<p>3.为什么需要一致性快照？全局一致性快照和 flink 的关系？</p>
<p>● 实时案例<br>    ○ 做检查点（全局一致性快照）用来故障恢复，重点就在于我们不必要从历史起点开始重跑所有的数据；（1.kafka 不可能存储历史所有数据 2.重跑历史数据的情况下，时效性是达不到要求的）</p>
<pre><code>○ 可以做任务的死锁检测</code></pre><p>4.全局一致性快照的分布式应用案例？<br>通过一个简单分布式应用介绍一下全局一致性状态是每时每刻都存在的。时间轴上的每一个时刻都存在一个全局一致性快照（拍照片）。</p>
<p>示例<br>下面分布式应用的一个示例：</p>
<p>每时每刻都存在全局一致性快照<br>上面这个只是四个时刻的四个快照，其实应用的每一个时刻都存在一个全局一致性快照。</p>
<p>5.全局一致性快照的标准定义<br>定义<br>假如说有两个事件，a和b，在绝对时间下，如果a发生在b之前，且b被包含在快照当中，那么则a也被包含在快照当中。满足这个条件的全局快照，就称为全局一致性快照。</p>
<p>本质<br>就是如果将做了绝对时刻 T 的一个快照，那么这个绝对时刻 T 之前发生的所有事件以及其影响都会被包含在这个快照中</p>
<p>6.怎么实现全局一致性快照？<br>同步实现方式<br>● 同步实现方式：时钟同步<br>NTP（<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/NTP%E6%9C%8D%E5%8A%A1%E5%99%A8/8633994?fr=aladdin）">https://baike.baidu.com/item/NTP%E6%9C%8D%E5%8A%A1%E5%99%A8/8633994?fr=aladdin）</a>: NTP服务器【Network Time Protocol（NTP）】是用来使计算机时间同步化的一种协议，它可以使计算机对其服务器或时钟源（如石英钟，GPS等等)做同步化，它可以提供高精准度的时间校正（LAN上与标准间差小于1毫秒，WAN上几十毫秒）<br>结论：无法实现<br>● 同步实现方式：Stop-The-World（<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/b210f9db19a3）">https://www.jianshu.com/p/b210f9db19a3）</a></p>
<p>结论：不满足需求，无法采用</p>
<p>异步实现方式<br>如果同步实现方式不满足需求，那么能使用异步做到同步相同的快照也是可以满足需求的<br>● 异步实现方式：chandy-lamport<br>论文：<a target="_blank" rel="noopener" href="https://www.microsoft.com/en-us/research/uploads/prod/2016/12/Determining-Global-States-of-a-Distributed-System.pdf?ranMID=24542&amp;ranEAID=J84DHJLQkR4&amp;ranSiteID=J84DHJLQkR4-mVoVymFnAblBx3zwyf98Pw&amp;epi=J84DHJLQkR4-mVoVymFnAblBx3zwyf98Pw&amp;irgwc=1&amp;OCID=AID2000142_aff_7593_1243925&amp;tduid=%28ir__1hs2uuow6wkfq3oxkk0sohzzwm2xpc33lxd0o6g200%29%287593%29%281243925%29%28J84DHJLQkR4-mVoVymFnAblBx3zwyf98Pw%29%28%29&amp;irclickid=_1hs2uuow6wkfq3oxkk0sohzzwm2xpc33lxd0o6g200">https://www.microsoft.com/en-us/research/uploads/prod/2016/12/Determining-Global-States-of-a-Distributed-System.pdf?ranMID=24542&amp;ranEAID=J84DHJLQkR4&amp;ranSiteID=J84DHJLQkR4-mVoVymFnAblBx3zwyf98Pw&amp;epi=J84DHJLQkR4-mVoVymFnAblBx3zwyf98Pw&amp;irgwc=1&amp;OCID=AID2000142_aff_7593_1243925&amp;tduid=%28ir__1hs2uuow6wkfq3oxkk0sohzzwm2xpc33lxd0o6g200%29%287593%29%281243925%29%28J84DHJLQkR4-mVoVymFnAblBx3zwyf98Pw%29%28%29&amp;irclickid=_1hs2uuow6wkfq3oxkk0sohzzwm2xpc33lxd0o6g200</a></p>
<p>7.分布式应用的全局一致性快照其 Process 状态和 Channel状态记录了什么？怎么记录 Channel 的状态？<br>Channel 记录了什么<br>分布式应用要记录的状态<br>如下图案例 Single-Token conservation，这是一个分布式应用，分布式应用中有 p 和 q 两个进程，p 可以通过 Channel pq 向 q 发消息，q 可以通过 Channel qp 向 p 发消息，其中有一个叫 token 的消息，在这个系统中一直不停的流转</p>
<p>如之前所述，分布式应用的全局一致性快照包含 Process 状态和 Channel 状态<br>那么上图 Single-Token conservation 示例中的<br>全局一致性快照 S = S(p) + S(Cpq) + S(q) + S(Cqp)<br>其中：<br>● S：全局一致性快照<br>● S(p)：p 进程的状态<br>● S(Cpq)：p 进程到 q 进程的 Channel 状态<br>● S(q)：q 进程的状态<br>● S(Cqp)：q 进程到 p 进程的 Channel 状态</p>
<p>问题：<br>这里大家可能会提到一个问题：做全局一致性快照时，其中 S(p)，S(q) 好理解，但是 S(Cpq)，S(Cqp) 到底应该记录什么东西？接下来详细讲讲我的理解<br>Process 状态应该记录什么内容<br>记录和用户业务需求相关的状态内容，用到了关于状态的地方，进行记录就好了<br>举例：uid 去重就存储历史所有的 uid 就可以了</p>
<p>Channel 状态应该记录什么内容</p>
<p>做全局一致性状态 token 应该都在相同的地方<br>全局一致性快照<br>token 在 p 时，对应第一张图，这时的全局一致性快照为：<br>S(token-in-p) = S(p-token-in-p) + S(Cpq-token-in-p) + S(q-token-in-p) + S(Cqp-token-in-p) ；<br>其中：<br>● S(token-in-p)：token 在 p 时，做的全局一致性快照<br>● S(p-token-in-p)：token 在 p 时，p 进程的状态<br>● S(Cpq-token-in-p)：token 在 p 时，p 进程到 q 进程的 Channel 状态<br>● S(q-token-in-p)：token 在 p 时，q 进程的状态<br>● S(Cqp-token-in-p)：token 在 p 时，q 进程到 p 进程的 Channel 状态</p>
<p>注意，上述这个表达式其实是结论，这个结论是很好理解的，但是你有想过站在实际应用的角度去思考怎样才能做一个实际快照时x下面的问题吗？</p>
<p>● 问题1：为什么都是 Process 和 Channel 做的快照都有 token-in-p 呢？<br>根据之前的拍照片的类比，当前这个绝对时刻做快照时，token 在 p；那么所有的 process 和 channel 记录状态时，token 都应该在 p。<br>● 问题2：S(p-token-in-p) 好理解，在这个时刻 token 还没有从 p 发出去，p 做快照时肯定知道 token 还在 p；但是站在 Cpq 做状态的角度来说</p>
<ol>
<li>Cpq 做状态时，怎么保障 Cpq 知道 token in p？需要我们探索下有什么方法怎么让 Cpq 在做状态时知道 token in p？</li>
<li>站在实际在应用中实现的角度时，满足怎样的数学条件（我们要开始实现一个真实的全局一致性快照啦，肯定会涉及到一些数据知识，别急，往后看，用到的数学知识并不复杂）才能做出一个 S(Cpq-token-in-p) 的状态？</li>
<li>同样的 S(q-token-in-p)，S(Cqp-token-in-p) 又怎么去做才能做到呢？</li>
</ol>
<p>首先我们得知道 S(Cpq-token-in-p)  存储了什么东西，然后我们才能知道做到存储出 S(Cpq-token-in-p) 这些东西需要满足什么条件：我们从上面的结论 S(token-in-p) = S(p-token-in-p) + S(Cpq-token-in-p) + S(q-token-in-p) + S(Cqp-token-in-p)  出发，来推导 Cpq 和 Cqp 这两个 Channel 做的状态到底存储了什么东西。</p>
<p>Cpq 记录 S(Cpq) 前应该满足的条件<br>条件1</p>
<ol>
<li>定义两个变量：<br>● n：在 p 的状态记录前，p 记录的 p 发往 Cpq 的 msg 数；<br>● n′：在 Cpq 的状态记录前，Cpq 记录的 p 发往 Cpq 的 msg 数；</li>
<li>结论：如果要让 Cpq 做状态时，知道 token in p（即满足 S(Cpq-token-in-p) 的全局状态），那么必然会有 n = n’；</li>
<li>反证法：如果 n != n’，则会有两种情况：<br>● n &gt; n’ 时：<br> ○ 可能会出现 n = 10（p 记录状态前，p 记录 p 发往 Cpq msg 数为 10（msg 编号 1 - 10））；<br> ○ n’ = 7（Cpq 记录状态前，Cpq 记录 p 发往 Cpq 的 msg 数为 7（msg 编号 1 - 7））；<br> ○ 那么假设 token 的编号为 9，就会出现 p 记录的状态为 S(p-token-in-Cpq)，Cpq 记录的状态为 S(p-token-in-p)，实际是不可能出现的；<br>● n &lt; n’ 时：<br> ○ 可能会出现 n = 7（p 记录状态前，p 记录 p 发往 Cpq msg 数为 7（编号 1 - 7））；<br> ○ n’ = 10（Cpq 记录状态前，Cpq 记录 p 发往 Cpq 的 msg 数为 10（编号 1 - 10））；<br> ○ 那么假设 token 的编号为 9，就会出现 p 记录的状态为 S(p-token-in-p)，Cpq 记录的状态为 S(p-token-in-Cpq)，实际是不可能出现的；<br>●  n = n’ 时：保障了无论什么情况下，只要 p 做出 S(p-token-in-p) 的状态时，因为 n = n’，代表 p 没有把 token 发出去，Cpq 也没有接受到 token，就能让 Cpq 也做出 S(Cpq-token-in-p)；</li>
</ol>
<p>Token in Cpq<br>全局一致性快照<br>token 在 Cpq 时，对应第二张图，这时的全局一致性状态为：<br>S(token-in-Cpq) = S(p-token-in-Cpq) + S(Cpq-token-in-Cpq) + S(q-token-inCpq) + S(Cqp-token-in-Cqp) ；<br>其中：<br>● S(token-in-Cpq) ：token 在 p 时，做的全局一致性快照<br>● S(p-token-in-Cpq) ：token 在 p 时，p 进程的状态<br>● S(Cpq-token-in-Cpq) ：token 在 p 时，p 进程到 q 进程的 Channel 状态<br>● S(q-token-in-p)：token 在 p 时，q 进程的状态<br>● S(Cqp-token-in-p)：token 在 p 时，q 进程到 p 进程的 Channel 状态</p>
<p>条件2</p>
<ol>
<li>定义两个变量：<br>● m：在 q 的状态记录前，q 记录的 q 从 Cpq 中接收到的 msg 数；<br>● m′：在 Cpq 的状态记录前，Cpq 记录的 q 从 Cpq 中接收到的 msg 数；</li>
<li>结论：如果要让 q 做状态时，知道 token in p（即做出满足 S(q-token-in-p) 的全局状态），那么必然会有 n′ ≥ m′ and n ≥ m and m = m’；</li>
<li>证明：<br>●  n′≥m′ and n≥m：在任何一种情况下，做全局一致性快照时，都会有 Cpq 下游接收到的 msg 数不可能超过 p 发送给 Channel 的 msg 条数，即：n′≥m′以及 n≥m<br>● m = m’：也是反证法，同上<br> ○ m &gt; m’ 时：<pre><code>■ 可能会出现 n = n&apos; = m &gt; m&apos;，q 记录状态前，Cpq 记录 q 从 Cpq 接收到的 msg 数为 10（编号 1 - 10，因为 n = n&apos; = m 也即 Cpq 记录的 p 发往 Cpq 的那些 msg）；
■ Cpq记录状态前，Cpq 记录的 q 从 Cpq 接收到的 msg 数为 7（编号 1 - 7）；
■ 那么假设 token 的编号为 9，就会出现 Cpq 记录的状态为 S(Cpq-token-in-Cpq)，q 记录的状态为 S(q-token-in-p)，实际是不可能出现的；</code></pre></li>
</ol>
<p>结论<br>在任何一种状态下，都会有 Cpq 下游接收到的 msg 数不可能超过 p 发送给 Channel 的 msg 条数，即：n′≥m′以及 n≥m</p>
<p>Channel 状态记录了什么内容？<br>一个 Channel 要记录的状态是，它 sender 记录自己状态之前它所接收到的 msg 列表，再减去 receiver 记录自己状态之前它已经收到的 msg 列表，减去的之后的数据列表就是还在通道中的数据列表，这个列表是需要 Channel 作为状态记录下来的。<br>而如果 n′=m′，那么 Channel c 中要记录的 msg 列表就是 empty 列表。如果 n′&gt;m′，那么要记录的列表是 (m′+1),…n′对应的 msg 列表。<br>至此，Channel 状态记录的内容也就确定了下来，那么我们应该怎么去记录 Channel 中的内容？</p>
<p>Chandy-Lamport 记录 Channel 状态中内容的方法<br>当消息在 Channel 上乱飞时，我们是无法记录这些消息作为 Channel 的状态的，但是这些消息终究会到达目的地，我们可以在消息的目的地去记录这些消息作为 Channel 的状态。那么具体怎么做的？就是在发送数据中插入一条特殊的数据 —— marker 数据，这条数据不会对计算有任何影响，即不会对应用的状态有任何影响，只是一个标识；<br>q 在没有记录自己的状态时，接收到了 Cpq 传来的 marker，那么 q 就开始记录自己的状态，并且把 Cpq 记录为空；如果 q 已经记录了自己的状态，那么在收到 marker 之前从 Cpq 接收到 msg 列表就是 Cpq 的状态</p>
<p>那么可以得到一个算子应该记录的状态就是自己的状态和 input Channel 的状态；</p>
<p>S_all = null;</p>
<p>// 1.假设 q 进程初始化发起快照的进程<br>S_q_all = S_q; // 初始化快照进程 q 做完快照，快照为 S_q</p>
<p>// 由于当前 q 已经做了快照，所以直接开始记录  y 个 input channel 的消息数据<br>for (int i = 1; i &lt;= y; i++) { // 假设当前源进程有 y 个 input channel<br>  S_Ciq = Message[m_iq + 1] + … + Message[n_iq];<br>  // n_iq 为 i 做快照前，i 发往 Ciq 的消息个数<br>  // m_iq 为 q 做快照前，q 收到 Ciq 的消息个数，其中 m_iq 可以que’d<br>  // 但是这里的 n_iq 不确定，所以要等待 i 做快照，并且 i 发往 Ciq 的消息全部到达 q，就知道 n_iq 是多少了<br>  S_q_all += S_Ciq;<br>}</p>
<p>S_all += S_q_all;</p>
<p>// 2.假设 p 进程为其他进程（非初始化发起快照进程）<br>S_p_all = S_p;</p>
<p>for (int i = 1; i &lt;= x; i++) { // 假设有 x 个 input channel<br>  S_Cip = Message[m_ip + 1] + … + Message[n_ip]; // n_ip 为 i 做快照前，i 发往 Cip 的消息个数，m_ip 为 p 做快照前，p 收到 Cip 的消息个数；<br>  // m_ip 可以在 p 做快照时确定下来<br>  // n_ip 得等 i 做快照，并且 i 发往 Ciq 的消息全部到达 p，就知道了 n_ip 是多少了</p>
<p>  S_p_all += S_Cip;<br>}</p>
<p>S_all += S_p_all;<br>marker 的功能：就是为了帮我们找出 n_iq 和 n_ip 的</p>
<p>接下来我们介绍介绍 Chandy-Lamport 是怎么做的。</p>
<p>8.Chandy-Lamport 算法流程、示例<br>算法流程</p>
<p>发起快照</p>
<p>解读：本次快照的起始点，先把起始点的快照给做了，然后发出 marker（这个 Marker 消息是干啥用的呢？？？），开始记录 input channel</p>
<p>执行快照</p>
<p>解读：<br>● Pi 记录本地快照，标记 Cki 为空：因为从 Cki 接收到了 marker，这时的状态是 Pk 刚刚做完快照，Pk 做完快照发往 Cki 的消息个数 = Pi 做完快照从 Cki 接收到的消息个数。即 n = n’ = m’ = m；即 Cki = [Empty]；<br>● Pi 开始向所有 output Channle 发 marker，开始记录除 Cki 之外的 input channel 消息，因为本地快照已经做完了；然后上游还有部分进程没有做完快照，为了记录除 Cki 之外的 input Channel 消息，</p>
<p>解读：结合前一张图说的开始记录 input channel 消息，Pi 停止记录 Cki 的消息，同时将此前记录所有 Cki 收到的消息作为本次快照中的最终状态；n’ &gt; m’，在 Pi 这里记录了 Cki 的状态，即 Cki = [m‘ + 1, m’ + 2…n]</p>
<p>终止快照</p>
<p>示例</p>
<p>9.flink 实现的全局一致性快照介绍（flink 容错机制）<br>Chandy-Lamport与 Flink之间的关系</p>
<p>论文：<a target="_blank" rel="noopener" href="https://arxiv.org/pdf/1506.08603.pdf">https://arxiv.org/pdf/1506.08603.pdf</a></p>
<p>Flink 是分布式系统，所以 Flink 会采用全局一致性快照的方式形成检查点，来支持故障恢复。Flink的异步全局一致性快照算法跟Chandy-Lamport算法的区别主要有以下几点：<br>● 第一，Chandy-Lamput支持强连通图，而 Flink支持弱连通图；<br>● 第二，Flink采用的是裁剪的（Tailored）Chandy-Lamput异步快照算法；<br>● 第三，Flink的异步快照算法在DAG场景下不需要存储 Channel state，从而极大减少快照的存储空间。<br>flink 的容错机制</p>
<p>端到端的Exactly once<br>Exactly once的意思是，作业结果总是正确的，但是很可能产出多次；所以它的要求是需要有可重放的source。<br>端到端的Exactly once，是指作业结果正确且只会被产出一次，它的要求除了有可重放的source外，还要求有事务型的sink和可以接收幂等的产出结果。</p>
<p>flink 的全局一致性快照</p>
<p>Barrier 对齐</p>
<p>状态后端<br>JVM Heap<br>、<br>第一种，JVM Heap，它里面的数据是以Java对象形式存在的，读写也是以对象形式去完成的，所以速度很快。但是也存在两个弊端：第一个弊端，以对象方式存储所需的空间是磁盘上序列化压缩后的数据大小的很多倍，所以占用的内存空间很大；第二个弊端，虽然读写不用做序列化，但是在形成snapshot时需要做序列化，所以它的异步snapshot过程会比较慢。</p>
<p>RocksDB</p>
<p>第二种，RocksDB，这个类型在读写时就需要做序列化，所以它读写的速度比较慢。但是它有一个好处，基于LSM的数据结构在快照之后会形成sst文件，它的异步checkpoint过程就是文件拷贝的过程，CPU消耗会比较低。</p>

        
      </div>
      
      
      
    </div>
    
    
    
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name"></p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%20%7C%7C%20archive">
              
                  <span class="site-state-item-count">62</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">16</span>
                  <span class="site-state-item-name">categories</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BA-%E5%85%A8%E5%B1%80%E4%B8%80%E8%87%B4%E6%80%A7%E5%BF%AB%E7%85%A7"><span class="nav-number">1.</span> <span class="nav-text">深入浅出 | 全局一致性快照</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%9B%AE%E5%BD%95"><span class="nav-number">2.</span> <span class="nav-text">目录</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E7%8A%B6%E6%80%81%EF%BC%9F%EF%BC%88%E4%BA%86%E8%A7%A3%E7%8A%B6%E6%80%81%EF%BC%89"><span class="nav-number">3.</span> <span class="nav-text">什么是状态？（了解状态）</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">yangyichao-mango</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
